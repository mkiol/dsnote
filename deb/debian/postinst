#!/bin/sh
# postinst script for dsnote.

set -e

setup_venv() {
    VENV_DIR="/opt/dsnote/venv"

    echo "** Setting up Python virtual environment for Speech Note..."

    # Create venv if it doesn't exist
    if [ ! -d "$VENV_DIR" ]; then
        python3 -m venv "$VENV_DIR" || {
            echo "** Failed to create virtual environment"
            echo "** Please install python3-venv: sudo apt install python3-venv"
            return 1
        }
    fi

    # Activate and install packages
    echo "** Installing Python packages (this may take a few minutes)..."
    "$VENV_DIR/bin/pip" install --upgrade pip
    "$VENV_DIR/bin/pip" install torch==2.8.0 transformers==4.57.0 tokenizers==0.22.1 numpy==2.3.0 accelerate sympy charset-normalizer setuptools || {
        echo "** Failed to install Python packages"
        return 1
    }

    echo "** Python virtual environment setup complete"
}

case "$1" in
    configure)
        setup_venv
    ;;

    abort-upgrade|abort-remove|abort-deconfigure)
    ;;

    *)
        echo "postinst called with unknown argument '$1'" >&2
        exit 1
    ;;
esac

exit 0

